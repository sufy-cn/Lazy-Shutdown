<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
	</head>
	<style>
		* {
			margin: 0;
			padding: 0;
			text-align: center;
		}

		button {
			width: 30vw;
			height: 10vw;
			font-size: 4vw;
			word-wrap: break-word;
			border-radius: 3vw;

		}

		a,
		p,
		input {
			font-size: 4.5vw;
			word-wrap: break-word;
		}

		input {
			border: none;
		}

		.add-T {
			color: #949494;
		}
	</style>
	<body>
		<div style="margin-top: 50%;">
			<a>目标 IP:
				<input id="IPs" value="" oninput="onIP()" />
			</a>
			<br /><br />
			<a>定时时间:
				<input id="TIMEs" value="" oninput="onTIME()" />
				<a>S</a>
			</a>
			<br /><br />
			<div style="display: flex;justify-content: space-around;">
				<button onclick="shutdown(0)">马上关机</button>
				<button onclick="shutdown(1)">取消关机</button>
				<button onclick="shutdown(2)">定时关机</button>
			</div>
			<div id="stateText">
				<p>消息</p>
			</div>
		</div>
	</body>
	<script>
		const stateText = document.getElementById('stateText') // 消息
		const IPs = document.getElementById('IPs') // IP
		const TIMEs = document.getElementById('TIMEs') // 时间

		IPs.value = localStorage.getItem('ip') || '192.168.1.103'
		TIMEs.value = localStorage.getItem('time') || 500
		let ws;
		try{
			ws = new WebSocket(`ws://${IPs.value}:8888`)
		}catch(msg){
			stateText.innerHTML += "<p class='add-T'>请检查目标IP</p>"
		}
		_init() // 开启服务



		function shutdown(val) { // 关机
			// 0 马上关机 1 取消关机 2 定时关机
			const temp = ['shutdown', 'shutdown -a', 'shutdown -time']
			const data = {
				text: temp[val],
				time: temp[val] === 'shutdown -time' ? getTime() : 0
			}
			ws.send(JSON.stringify(data))

			function getTime() {
				if (!localStorage.getItem('time')) {
					return 500
				} else {
					return localStorage.getItem('time')
				}
			}
		}



		function _init() { // 连接
			ws.onopen = function(evt) {
				console.log("Connection open ...");
				stateText.innerHTML += "<p class='add-T'>打开连接</p>"
				ws.send("1");
			};
		}

		ws.onmessage = function(evt) {
			stateText.innerHTML += "<p class='add-T'>" + evt.data + "</p>"
		};

		ws.onclose = function(evt) {
			setTimeout(() => {
				_init()
			}, 1500)
			stateText.innerHTML += "<p class='add-T'>连接已关闭</p>"
		};
		ws.onerror = function(evt){
			console.log(evt)
		}

		function onIP(val) {
			localStorage.setItem('ip', IPs.value)
		}

		function onTIME(val) {
			localStorage.setItem('TIME', TIMEs.value)
		}
	</script>
</html>
